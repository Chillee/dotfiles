#! /bin/sh

# Hybrid theme
foreground='#707880'
background='#1D1F21'
red='#A54242'
lightred='CC6666'
green='#8C9440'
lightgreen='#B5BD68'
orange='#DE935F'
yellow='#F0C674'
blue='#5F819D'
lightblue='#81A2BE'
purple='#85678F'
lightpurple='#B294BB'
indigo='#5E8D87'
lightindigo='#8ABEB7'
white='#C5C8C6'

if [ $(pgrep -cx panel) -gt 1 ] ; then
    printf "%s\n" "The panel is already running." >&2
    exit 1
fi

cleanup() {
	trap - TERM
	rm "$PANEL_FIFO"
	bspc config top_padding 0
	kill 0
}
trap 'cleanup' INT TERM QUIT EXIT

[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"
bspc config top_padding "$PANEL_HEIGHT"

{
	bspc control --subscribe &
	sleep 0.01 # Don't choke bar
	echo "V"
	sleep 0.01
	battery -s -f 'B%s %i' &
	sleep 0.01
	xtitle -s -f 'T%s' &
	sleep 0.01
	essid -s -w wlp2s0 -f 'N%s' &
	sleep 0.01
	clock -s -f "C%{F-}%a %d %{F$white}%-l:%M"
} > "$PANEL_FIFO" &

while read -r line ; do
    case $line in
		T*)
			# title output
			title_infos="%{F-}${line#?}"
			;;
		V*)
			# volume output
			IFS='[]%' read -r -d'\0' -a volStats <<< "$(amixer get Master)"
			if [[ "${volStats[6]}" == "on" ]]; then
				volume_infos="%{F-}${volStats[1]}"
			else
				volume_infos="%{F-}${volStats[1]}"
			fi
			;;
		B*)
			# battery output
			IFS=' ' read -r -a batStats <<< "${line#?}"
			bat_status=${batStats[0]}
			bat_charge=${batStats[1]}

			if [ $bat_charge -ge 35 ]; then
				charge_color=6
			elif [ $bat_charge -ge 15 ]; then
				charge_color=1
			else charge_color=8
			fi

			if [ "$bat_status" == "Charging" ]; then
				battery_infos="%{F$blue}⮒ %{F-}${bat_charge}+"
			elif [ "$bat_status" == "Discharging" ]; then
				battery_infos="%{F$blue}${bat_charge}-"
			else 
				battery_infos="%{F$blue}⮎ %{F-}AC"
			fi
			;;
        C*)
            # clock output
            clock_infos="%{F$blue}⭧ ${line#?}"
            ;;
		N*)
			# network
			net_name="${line#?}"
			if [[ -n "$net_name" ]]; then
				IFS=' |.' read -r -d'\0' -a wlInfo < /proc/net/wireless
				sigStrength=${wlInfo[20]}

				if [[ $sigStrength -ge 65 ]]; then
					network_infos="%{F$blue}‗▬▪▮ %{F-}${net_name}"
				elif [[ $sigStrength -ge 40 ]]; then
					network_infos="%{F$blue}‗▬▪%{F-}▮ ${net_name}"
				else
					network_infos="%{F$blue}‗▬%{F-}▪▮ ${net_name}"
				fi
			else
				network_infos="%{F-}‗▬▪▮ Not connected"
			fi
			;;
        W*)
            # bspwm internal state
            wm_infos=""
            IFS=':'
            set -- ${line#?}
            while [ $# -gt 0 ] ; do
                item=$1
                name=${item#?}
                case $item in
                    [OFU]*)
                        # active desktop
                        wm_infos="$wm_infos%{F$white} • "
                        ;;
                    o*)
                        # inactive but occupied desktop
                        wm_infos="$wm_infos%{F-} • "
                        ;;
                    f*)
                        # inactive desktop
                        wm_infos="$wm_infos%{F-} ○ "
                        ;;
                    u*)
                        # urgent desktop
                        wm_infos="$wm_infos%{F$red} • "
                        ;;
                esac
                shift
            done
            ;;
    esac
	echo "%{l}$title_infos%{c}$wm_infos%{r}$volume_infos  $network_infos $battery_infos $clock_infos"
done < "$PANEL_FIFO" | bar -f '-*-terminesspowerline-medium-r-normal-*-18-*-*-*-*-*-*-*' -u 0 -F $foreground -B $background 

wait
